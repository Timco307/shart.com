<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Anon Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: dark; --bg:#0f1115; --panel:#151821; --text:#e6e9ef; --muted:#9aa3b2; --accent:#5b93ff; --border:#232739; --input:#1b1f2b; --danger:#ff6b6b; }
    body { margin:0; background:var(--bg); color:var(--text); font:15px system-ui; display:grid; min-height:100vh; grid-template-rows:auto 1fr; }
    header { background:var(--panel); border-bottom:1px solid var(--border); padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    header .room { font-weight:600; }
    header .status { color:var(--muted); font-size:12px; }
    .screen { display:grid; place-items:center; padding:24px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:10px; max-width:420px; width:100%; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    .card h2 { margin-top:0; text-align:center; }
    .row { display:grid; gap:12px; margin-top:16px; }
    input { background:var(--input); border:1px solid var(--border); color:var(--text); padding:12px; border-radius:8px; }
    input::placeholder { color:var(--muted); }
    button { background:var(--accent); border:none; color:white; padding:12px; border-radius:8px; font-weight:600; cursor:pointer; }
    button:hover { opacity:0.9; }
    #error { color:var(--danger); font-size:14px; margin-top:8px; text-align:center; }
    main.chat { display:grid; grid-template-rows:1fr auto; height:calc(100vh - 54px); }
    #messages { overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .msg { padding:10px; background:var(--panel); border:1px solid var(--border); border-radius:8px; max-width:720px; }
    .msg.system { color:var(--muted); font-style:italic; }
    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); background:var(--panel); }
    .composer input { flex:1; }
  </style>
</head>
<body>
<header id="header" style="display:none;">
  <div class="room">Room: <span id="roomLabel"></span></div>
  <div class="status" id="status">Connected</div>
</header>

<div class="screen" id="joinScreen">
  <div class="card">
    <h2>Join or Create a Room</h2>
    <div class="row">
      <input id="name" placeholder="Your name"/>
      <input id="room" placeholder="Room code"/>
      <input id="password" type="password" placeholder="Password (optional)"/>
      <input id="limit" type="number" min="1" placeholder="User limit (optional)"/>
      <button id="joinBtn">Join Room</button>
      <div id="error"></div>
    </div>
  </div>
</div>

<main class="chat" id="chatScreen" style="display:none;">
  <div id="messages"></div>
  <div class="composer">
    <input id="msg" placeholder="Type a message"/>
    <button id="sendBtn">Send</button>
  </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
const url=new URL(window.location.href);
const qpRoom=url.searchParams.get("room");
if(qpRoom) document.getElementById("room").value=qpRoom;

const socket=io();
let currentRoom=null;
let userName=null;

const joinScreen=document.getElementById("joinScreen");
const chatScreen=document.getElementById("chatScreen");
const header=document.getElementById("header");
const roomLabel=document.getElementById("roomLabel");
const statusEl=document.getElementById("status");
const nameInput=document.getElementById("name");
const roomInput=document.getElementById("room");
const passInput=document.getElementById("password");
const limitInput=document.getElementById("limit");
const joinBtn=document.getElementById("joinBtn");
const errorEl=document.getElementById("error");
const messagesEl=document.getElementById("messages");
const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("sendBtn");

function showChat(){
  joinScreen.style.display="none";
  header.style.display="flex";
  chatScreen.style.display="grid";
  roomLabel.textContent=currentRoom;
}
function addMsgEl(d){
  const div=document.createElement("div");
  div.className="msg"+(d.system?" system":"");
  div.innerHTML=d.system?escapeHtml(d.text):("<b>"+escapeHtml(d.name)+":</b> "+escapeHtml(d.text));
  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}

joinBtn.onclick=()=>{
  errorEl.textContent="";
  userName=nameInput.value.trim()||"Anon";
  currentRoom=roomInput.value.trim()||"default";
  const password=passInput.value.trim()||null;
  const limit=parseInt(limitInput.value,10)||null;
  socket.emit("join",{room:currentRoom,name:userName,password,limit});
};
sendBtn.onclick=sendMsg;
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter")sendMsg();});
function sendMsg(){
  const text=msgInput.value.trim();
  if(!text||!currentRoom)return;
  socket.emit("message",{room:currentRoom,name:userName,text});
  msgInput.value="";
}

socket.on("joined",({room,messages})=>{
  currentRoom=room;
  showChat();
  messagesEl.innerHTML="";
  messages.forEach(addMsgEl);
  addMsgEl({name:"System",text:"You joined room "+room,system:true});
  statusEl.textContent="Connected";
  history.replaceState({}, "", "/?room="+encodeURIComponent(room));
});
socket.on("join-error",({error})=>{
  errorEl.textContent=error;
});
socket.on("message",addMsgEl);
socket.on("room-deleted",({code})=>{
  if(currentRoom===code){
    addMsgEl({name:"System",text:"Room was deleted due to inactivity/age.",system:true});
    statusEl.textContent="Disconnected";
  }
});
socket.on("disconnect",()=>{statusEl.textContent="Disconnected";});
</script>
</body>
</html>
