<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Anon Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: dark; --bg:#0f1115; --panel:#151821; --text:#e6e9ef; --muted:#9aa3b2; --accent:#5b93ff; --border:#232739; --input:#1b1f2b; --danger:#ff6b6b; }
    body { margin:0; background:var(--bg); color:var(--text); font:15px system-ui; display:grid; min-height:100vh; grid-template-rows:auto 1fr; }
    header { background:var(--panel); border-bottom:1px solid var(--border); padding:10px 16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    header .room { font-weight:600; }
    header .status { color:var(--muted); font-size:12px; margin-left:10px; }
    header .users { font-size:13px; color:var(--muted); margin-top:4px; width:100%; }
    .screen { display:grid; place-items:center; padding:24px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:10px; max-width:420px; width:100%; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,0.4); }
    .card h2 { margin-top:0; text-align:center; }
    .row { display:grid; gap:12px; margin-top:16px; }
    input { background:var(--input); border:1px solid var(--border); color:var(--text); padding:12px; border-radius:8px; }
    input::placeholder { color:var(--muted); }
    button { background:var(--accent); border:none; color:white; padding:12px; border-radius:8px; font-weight:600; cursor:pointer; }
    button:hover { opacity:0.9; }
    #joinError, #createError { color:var(--danger); font-size:14px; margin-top:8px; text-align:center; }
    main.chat { display:grid; grid-template-rows:1fr auto; height:calc(100vh - 70px); }
    #messages { overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .msg { padding:10px; background:var(--panel); border:1px solid var(--border); border-radius:8px; max-width:720px; position:relative; }
    .msg.system { color:var(--muted); font-style:italic; }
    .trash { position:absolute; right:8px; top:8px; cursor:pointer; display:none; }
    .msg.ctrl-hover .trash { display:inline; }
    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); background:var(--panel); }
    .composer input { flex:1; }
    .undo { color:var(--muted); font-size:12px; cursor:pointer; margin-left:8px; }
  </style>
</head>
<body>
<header id="header" style="display:none;">
  <div>
    <span class="room">Room: <span id="roomLabel"></span></span>
    <span class="status" id="status">Connected</span>
  </div>
  <div class="users" id="userList"></div>
</header>

<!-- Choice screen -->
<div class="screen" id="choiceScreen">
  <div class="card">
    <h2>Welcome</h2>
    <div class="row">
      <button id="goJoin">Join Room</button>
      <button id="goCreate">Create Room</button>
    </div>
  </div>
</div>

<!-- Join screen -->
<div class="screen" id="joinScreen" style="display:none;">
  <div class="card">
    <h2>Join Room</h2>
    <div class="row">
      <input id="joinName" placeholder="Your name"/>
      <input id="joinRoom" placeholder="Room code"/>
      <input id="joinPassword" type="password" placeholder="Password" style="display:none;"/>
      <button id="joinBtn">Join</button>
      <div id="joinError"></div>
    </div>
  </div>
</div>

<!-- Create screen -->
<div class="screen" id="createScreen" style="display:none;">
  <div class="card">
    <h2>Create Room</h2>
    <div class="row">
      <input id="createName" placeholder="Your name"/>
      <input id="createRoom" placeholder="Room code"/>
      <input id="createPassword" type="password" placeholder="Password (optional)"/>
      <input id="createLimit" type="number" min="1" placeholder="User limit (optional)"/>
      <button id="createBtn">Create</button>
      <div id="createError"></div>
    </div>
  </div>
</div>

<!-- Chat screen -->
<main class="chat" id="chatScreen" style="display:none;">
  <div id="messages"></div>
  <div class="composer">
    <input id="msg" placeholder="Type a message"/>
    <button id="sendBtn">Send</button>
  </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
const url=new URL(window.location.href);
const qpRoom=url.searchParams.get("room");

const socket=io();
let currentRoom=null;
let userName=null;
let pollInterval=null;

// Elements
const choiceScreen=document.getElementById("choiceScreen");
const joinScreen=document.getElementById("joinScreen");
const createScreen=document.getElementById("createScreen");
const chatScreen=document.getElementById("chatScreen");
const header=document.getElementById("header");
const roomLabel=document.getElementById("roomLabel");
const statusEl=document.getElementById("status");
const userListEl=document.getElementById("userList");
const messagesEl=document.getElementById("messages");
const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("sendBtn");

// Join form
const joinName=document.getElementById("joinName");
const joinRoom=document.getElementById("joinRoom");
const joinPassword=document.getElementById("joinPassword");
const joinBtn=document.getElementById("joinBtn");
const joinError=document.getElementById("joinError");

// Create form
const createName=document.getElementById("createName");
const createRoom=document.getElementById("createRoom");
const createPassword=document.getElementById("createPassword");
const createLimit=document.getElementById("createLimit");
const createBtn=document.getElementById("createBtn");
const createError=document.getElementById("createError");

// Choice buttons
document.getElementById("goJoin").onclick=()=>{choiceScreen.style.display="none";joinScreen.style.display="block";};
document.getElementById("goCreate").onclick=()=>{choiceScreen.style.display="none";createScreen.style.display="block";};

// If shared link with ?room=CODE
if(qpRoom){
  fetch("/roominfo/"+encodeURIComponent(qpRoom))
    .then(r=>r.json())
    .then(info=>{
      choiceScreen.style.display="none";
      joinScreen.style.display="block";
      joinRoom.value=qpRoom;
      if(info.exists && info.hasPassword){
        joinPassword.style.display="block";
      }
    });
}

function showChat(){
  joinScreen.style.display="none";
  createScreen.style.display="none";
  header.style.display="flex";
  chatScreen.style.display="grid";
  roomLabel.textContent=currentRoom;
}

function addMsgEl(d){
  const div=document.createElement("div");
  div.className="msg"+(d.system?" system":"");
  div.innerHTML=d.system?escapeHtml(d.text):("<b>"+escapeHtml(d.name)+":</b> "+escapeHtml(d.text));

  const trash=document.createElement("span");
  trash.textContent="🗑️";
  trash.className="trash";
  trash.onclick=()=>{
    div.style.display="none";
    const undo=document.createElement("span");
    undo.textContent="(undo)";
    undo.className="undo";
    undo.onclick=()=>{div.style.display="block";undo.remove();};
    div.parentNode.insertBefore(undo,div.nextSibling);
  };
  div.appendChild(trash);

  div.addEventListener("mouseenter", e=>{
    if(e.ctrlKey){ 
      div.classList.add("ctrl-hover");
    }
  });
  div.addEventListener("mouseleave", ()=>{
    div.classList.remove("ctrl-hover");
  });

  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}

// Join button
joinBtn.onclick=()=>{
  joinError.textContent="";
  userName=joinName.value.trim()||"Anon";
  currentRoom=joinRoom.value.trim()||"default";
  const password=joinPassword.value.trim()||null;
  socket.emit("join",{room:currentRoom,name:userName,password});
};

// Create button
createBtn.onclick=()=>{
  createError.textContent="";
  userName=createName.value.trim()||"Anon";
  currentRoom=createRoom.value.trim()||"default";
  const password=createPassword.value.trim()||null;
  const limit=parseInt(createLimit.value,10)||null;
  socket.emit("join",{room:currentRoom,name:userName,password,limit});
};

// Send message
sendBtn.onclick=sendMsg;
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter")sendMsg();});
function sendMsg(){
  const text=msgInput.value.trim();
  if(!text||!currentRoom)return;
  socket.emit("message",{room:currentRoom,name:userName,text});
  msgInput.value="";
}

// When joined, show chat and start polling
socket.on("joined",({room})=>{
  currentRoom=room;
  showChat();
  statusEl.textContent="Connected";
  history.replaceState({}, "", "/?room="+encodeURIComponent(room));
  startPolling(room);
});

// Errors
socket.on("join-error",({error})=>{
  if(joinScreen.style.display==="block"){
    joinError.textContent=error;
  } else if(createScreen.style.display==="block"){
    createError.textContent=error;
  }
});

// Instant messages
socket.on("message",addMsgEl);

// Room deleted
socket.on("room-deleted",({code})=>{
  if(currentRoom===code){
    addMsgEl({name:"System",text:"Room was deleted due to inactivity/age.",system:true});
    statusEl.textContent="Disconnected";
  }
});

// Disconnect
socket.on("disconnect",()=>{statusEl.textContent="Disconnected";});

// Polling loop to reconcile state every 5s
function startPolling(roomCode){
  if(pollInterval) clearInterval(pollInterval);
  pollInterval=setInterval(()=>{
    fetch("/room-data/"+encodeURIComponent(roomCode))
      .then(r=>r.json())
      .then(data=>{
        if(!data.exists){
          addMsgEl({name:"System",text:"Room no longer exists.",system:true});
          clearInterval(pollInterval);
          return;
        }
        // Update user list
        userListEl.textContent="Users: "+data.users.join(", ");
        // If server has more messages than we’ve rendered, append them
        if(data.messages.length > messagesEl.children.length){
          const newOnes = data.messages.slice(messagesEl.children.length);
          newOnes.forEach(addMsgEl);
        }
      });
  },5000);
}
</script>
</body>
</html>